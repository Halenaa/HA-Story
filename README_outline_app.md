# 📚 故事大纲生成器 - Streamlit 应用

这是一个基于 Streamlit 的交互式故事大纲生成和编辑工具，与你的故事系统后端完美集成。

## 🚀 功能特性

### ✅ 已实现的功能
- **大纲生成**: 基于题材和风格自动生成故事大纲
- **章节预览**: 清晰展示所有章节的标题和摘要
- **批量编辑**: 支持多选章节进行批量修改
- **章节重排**: 自动非线性重排 + 手动顺序调整
- **叙述分析**: 智能分析非线性叙述结构
- **多格式导出**: JSON、Markdown、纯文本格式
- **项目集成**: 与现有后端系统无缝对接

### 🎯 核心工作流程
1. **触发时机**: Outline生成并保存后
2. **预览结构**: 查看所有章节的title + summary
3. **批量选择**: 多选要修改的章节
4. **操作选项**: 重新生成/手动编辑/调整顺序/增删章节
5. **最终确认**: 确认整体结构并导出

## 🛠️ 安装和运行

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 运行应用
```bash
streamlit run outline_generator_app.py
```

### 3. 访问界面
应用将在浏览器中自动打开，默认地址：`http://localhost:8501`

## 📖 使用指南

### 第一步：配置参数
在左侧边栏设置：
- **故事题材**: 如"小红帽"
- **故事风格**: 如"科幻改写"
- **创造性**: 控制LLM的创造性程度
- **随机种子**: 确保结果可重现
- **章节顺序**: linear(线性) 或 nonlinear(非线性)

### 第二步：生成大纲
点击"🔄 生成新大纲"按钮，系统将：
1. 调用后端API生成大纲
2. 根据选择进行章节重排
3. 执行叙述结构分析
4. 显示完整的大纲结构

### 第三步：编辑和调整
应用提供四种编辑模式：

#### 👀 预览模式
- 查看完整大纲结构
- 显示叙述分析结果
- 展示章节位置信息

#### ✏️ 编辑模式
- **批量选择**: 多选要编辑的章节
- **内容编辑**: 修改标题、ID、摘要
- **重新生成**: 使用LLM重新生成特定章节
- **删除章节**: 移除不需要的章节
- **添加章节**: 创建新的章节内容

#### 🔄 重排模式
- **自动重排**: 智能非线性重排
- **叙述分析**: 分析重排后的叙述结构
- **手动调整**: 自定义章节顺序

#### 💾 保存导出
- **JSON格式**: 下载完整大纲数据
- **Markdown**: 生成可读性强的文档
- **纯文本**: 简单的文本格式
- **项目保存**: 保存到项目目录

## 🔧 技术架构

### 前端 (Streamlit)
- 响应式界面设计
- 状态管理 (session_state)
- 多模式编辑界面
- 实时预览和反馈
- 详细的执行日志显示

### 真实后端集成
- **完全依赖真实后端**: 不使用任何模拟功能
- **严格按照main_pipeline_glm.py结构**: 保持与后端完全一致的逻辑
- **详细日志记录**: 记录每个后端操作的耗时和结果
- **错误处理**: 当后端不可用时直接报错并停止运行

### 数据流
```
用户输入 → 参数配置 → 后端API调用 → 大纲生成 → 章节重排 → 叙述分析 → 编辑界面 → 导出保存
```

## 🎨 界面特色

- **直观的侧边栏**: 集中配置和操作
- **模式切换**: 清晰的编辑模式选择
- **实时反馈**: 操作结果即时显示
- **响应式布局**: 适配不同屏幕尺寸
- **中文界面**: 完全中文化的用户体验

## 🔄 与现有系统的集成

### 自动调用
- `generate_outline()`: 大纲生成
- `reorder_chapters()`: 章节重排
- `analyze_narrative_structure()`: 叙述分析
- `save_json()`: 文件保存

### 数据格式兼容
- 完全兼容现有的JSON格式
- 保留所有叙述分析字段
- 支持版本命名系统

## 🚨 注意事项

1. **后端依赖**: **必须**确保所有后端模块可正常导入，否则应用无法启动
2. **文件权限**: 确保有写入项目目录的权限
3. **内存使用**: 大型大纲可能占用较多内存
4. **网络连接**: 需要稳定的网络连接调用LLM API
5. **真实运行**: 应用不提供模拟模式，所有功能都依赖真实后端

## 🐛 故障排除

### 后端模块导入失败
- 检查Python路径设置
- 确认所有依赖已安装
- **应用将直接报错并停止运行**（不再有模拟模式）

### 大纲生成失败
- 检查网络连接
- 确认API密钥配置
- 查看错误日志信息

### 界面显示异常
- 刷新浏览器页面
- 检查Streamlit版本兼容性
- 清除浏览器缓存

## 📋 日志功能

### 实时执行日志
- **操作记录**: 记录每个后端操作的详细信息
- **耗时统计**: 显示每个操作的执行时间
- **结果摘要**: 显示操作结果的简要信息
- **错误追踪**: 记录失败操作的详细错误信息

### 日志文件
- **应用日志**: `streamlit_logs/outline_app_YYYYMMDD.log`
- **后端日志**: 按照main_pipeline_glm.py的日志系统记录
- **格式统一**: 时间戳 | 级别 | 消息内容

### 日志查看
- **实时显示**: 在应用界面中实时显示执行日志
- **可展开查看**: 点击展开查看详细的执行过程
- **颜色区分**: 成功(绿色)、警告(黄色)、错误(红色)、信息(蓝色)

## 🚀 未来扩展

- [ ] 角色设定编辑器
- [ ] 故事内容生成器
- [ ] 对话插入工具
- [ ] 版本对比功能
- [ ] 协作编辑支持
- [ ] 日志导出功能
- [ ] 性能监控面板

## 📞 技术支持

如有问题或建议，请：
1. 检查错误日志
2. 确认系统配置
3. 查看相关文档
4. 联系开发团队

---

**享受创作故事的乐趣！** 🎭✨ 